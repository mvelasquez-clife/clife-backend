<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Corporacion Life</title>
        <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.css">
        <link rel='stylesheet prefetch' href='http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css'>
        <link rel="stylesheet" href="/assets/datepicker/css/bootstrap-datepicker.css">
        <style>
            body { padding-top: 60px; }
            .navbar-brand {
                background-image: url('/assets/images/extranet/clife-logo-light.png');
                background-size: auto 30px;
                background-repeat: no-repeat;
                padding-left: 36px;
                font-size: 1.5rem;
                line-height: 1.75rem;
                height: 30px;
                width: 224px;
            }
        </style>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-cprimary">
            <a class="navbar-brand" href="#">Corporacion Life</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="nav-dropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Opciones</a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="nav-dropdown">
                            <a class="dropdown-item" href="#">Mis datos</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#" data-toggle="modal" data-target="#modal-logout">Cerrar sesión</a>
                        </div>
                    </li>
                </ul>
            </div>
        </nav>
        <div class="container">
            <div class="row justify-content-center mb-3" id="dv-busca-cliente">
                <div class="col-8">
                    <form id="form-busca" class="form-inline">
                        <label for="bs-cliente">Cliente</label>
                        <input type="text" class="form-control form-control-sm ml-2 w-50" id="bs-cliente" placeholder="Ingrese RUC o DNI">
                        <button type="submit" class="btn btn-sm btn-primary ml-2"><i class="fa fa-search"></i></button>
                    </form>
                </div>
            </div>
            <div class="row justify-content-center">
                <div class="col" id="container"></div>
            </div>
            <div class="row justify-content-center">
                <div class="col" id="aprobacion"></div>
            </div>
        </div>
        <!-- modals -->
        <!-- modal logout -->
        <div id="modal-logout" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title text-danger">Cerrar sesión</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>¿Desea cerrar la sesión? Tendrá que ingresar sus credenciales nuevamente la próxima vez</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-dismiss="modal">Cancelar</button>
                        <a href="/extranet/logout" class="btn btn-danger">Cerrar sesión</a>
                    </div>
                </div>
            </div>
        </div>
        <!-- modal busqueda de clientes -->
        <div id="modal-busqueda" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Resultados de la búsqueda:</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Código</th>
                                    <th>Cliente</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-dismiss="modal">Cancelar</button>
                        <a href="/extranet/logout" class="btn btn-danger">Cerrar sesión</a>
                    </div>
                </div>
            </div>
        </div>
        <!-- nuevo pedido -->
        <div id="modal-nuevo" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Nuevo pedido</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col">
                                <form id="form-nuevo">
                                    <p class="mb-2">Se registrará un nuevo pedido. A continuación, verifique sus datos.</p>
                                    <div class="form-group row">
                                        <label for="np-disponible" class="col-sm-3 col-form-label">Disponible</label>
                                        <div class="col-sm-5">
                                            <input type="text" readonly class="form-control-plaintext" id="np-disponible" value="S/ 5,000.00">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label for="np-fentrega" class="col-sm-3 col-form-label">Fecha pedido</label>
                                        <div class="col-sm-3">
                                            <input type="text" class="form-control form-control-sm datepicker" id="np-fentrega" placeholder="yyyy-mm-dd">
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary">Proceder con el pedido</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- detalle de pedido -->
        <div id="modal-detalle" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"></h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="t-codigo">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th colspan="2">Producto</th>
                                    <th>Cantidad</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="t-detalle">
                                <tr>
                                    <td colspan="4">No hay items</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th></th>
                                    <th>Total</th>
                                    <th id="t-cantidad" class="text-right">0</th>
                                    <th id="t-importe" class="text-right">0.00</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="btn-genera">Generar el pedido</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- scripts -->
        <script src="/assets/vendor/jquery/jquery-3.2.1.min.js"></script>
        <script src="/assets/bootstrap/js/popper.min.js"></script>
        <script src="/assets/bootstrap/js/bootstrap.min.js"></script>
        <script src="/assets/datepicker/js/bootstrap-datepicker.min.js"></script>
        <script src="/assets/datepicker/locales/bootstrap-datepicker.es.min.js" charset="UTF-8"></script>
        <script>
            let sesdata = JSON.parse('<%-sesion %>');
            let tmpCliente = '<%-cliente %>';
            let Cliente = null;

            BuscarClientes = async (event) => {
                event.preventDefault();
                let txt = document.getElementById('bs-cliente').value;
                let tbody = $('#modal-busqueda .modal-body .table tbody');
                tbody.empty().append(
                    $('<tr>').append(
                        $('<td>').attr('colspan', 3).html('Buscando...')
                    )
                );
                $('#modal-busqueda').modal('show');
                let result;
                try {
                    result = await $.ajax({
                        url: '/extranet/buscar-clientes',
                        method: 'post',
                        data: {
                            texto: txt,
                            tipo: sesdata.tipo
                        },
                        dataType: 'json'
                    });
                    if (result.error) {
                        alert(err);
                        return;
                    }
                    tbody.empty();
                    for (let fila of result.data.clientes) {
                        tbody.append(
                            $('<tr>').append(
                                $('<td>').append(
                                    $('<a>').attr({
                                        'href': '#',
                                        'data-codigo': fila.codigo
                                    }).append(
                                        $('<i>').addClass('fa fa-plus')
                                    ).addClass('btn btn-sm btn-primary').on('click', SeleccionarCliente)
                                )
                            ).append(
                                $('<td>').html(fila.codigo)
                            ).append(
                                $('<td>').html(fila.nombre)
                            )
                        );
                    }
                }
                catch (err) {
                    alert(err);
                    console.error(err);
                }
            }

            SeleccionarCliente = (event) => {
                event.preventDefault();
                $('#modal-busqueda').modal('hide');
                CargarDatosCliente(event.delegateTarget.dataset.codigo);
            }

            CargarDatosCliente = async (codigo) => {
                $('#container').empty();
                let result;
                try {
                    result = await $.ajax({
                        url: '/extranet/datos-cliente',
                        method: 'post',
                        data: { cliente: codigo },
                        dataType: 'json'
                    });
                    if (result.error) {
                        alert(result.error);
                        return;
                    }
                    Cliente = result.data.cliente;
                    let sDisponible = Cliente.disponible.toLocaleString('en-us', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    let sSolicita = Cliente.solicitud.toLocaleString('en-us', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    let sDeuda = Cliente.deuda.toLocaleString('en-us', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    let sNegativo = Cliente.disponible <= 0;
                    if (sNegativo && Cliente.disponible < 0.01) {
                        sDisponible = '0.00';
                        // $('#modal-nuevo .modal-footer .btn-primary').prop('disabled', true).empty().append('No dispone de crédito');
                        $('#np-disponible').addClass('text-danger');
                    }
                    else {
                        $('#np-disponible').addClass('text-success');
                    }
                    document.getElementById('np-disponible').value = Cliente.moneda + ' ' + sDisponible;
                    $('#container').append(
                        $('<h2>').html(Cliente.nombre).addClass('text-primary mb-1')
                    ).append(
                        $('<p>').html('Mostrando los datos del cliente').addClass('text-secondary')
                    ).append(
                        $('<div>').append(
                            $('<div>').append(
                                $('<div>').append(
                                    $('<p>').html('Saldo disponible: ' + Cliente.moneda + ' ' + sDisponible + ' - Solicitud de Crédito: ' + Cliente.moneda + ' ' + sSolicita + ' - Deuda: ' + Cliente.moneda + ' ' + sDeuda).addClass('mb-0')
                                ).addClass('alert ' + (sNegativo ? 'bg-danger' : 'bg-primary') + ' text-light')
                            ).addClass('col-auto')
                        ).addClass('row justify-content-center')
                    ).append(
                        $('<div>').append(
                            $('<div>').append(
                                $('<h3>').html('Pedidos').addClass('font-weight-light')
                            ).append(
                                $('<hr>')
                            ).append(
                                $('<div>').attr('id', 'pedido')
                            ).addClass('col')
                        ).addClass('row mb-5')
                    ).append(
                        $('<div>').append(
                            $('<div>').append(
                                $('<h3>').html('Cuenta corriente del cliente').addClass('font-weight-light')
                            ).append(
                                $('<div>').attr('id', 'ctacte')
                            ).addClass('col')
                        ).addClass('row mb-5')
                    );
                    // pedidos
                    let pedido = result.data.pedido;
                    if (pedido.codigo != 'x') {
                        $('#pedido').append(
                            $('<p>').append('Pedido pendiente: ').append(
                                $('<span>').addClass('text-primary font-weight-bold').html(pedido.codigo)
                            ).append(' con ' + pedido.items + ' items - Abierto el ' + pedido.fecha + ', por ' + pedido.moneda + ' ' + pedido.importe.toLocaleString('en-us', { minimumFractionDigits: 2, maximumFractionDigits: 2 })).addClass('mb-2')
                        ).append(
                            $('<a>').append(
                                $('<i>').addClass('fa fa-pencil')
                            ).attr('href', '/extranet/detalle-pedido/' + pedido.codigo).append(' Editar pedido ' + pedido.codigo).addClass('btn btn-success')
                        );
                    }
                    else {
                        $('#pedido').append(
                            $('<p>').html('No tiene pedidos pendientes').append(
                                $('<a>').attr({
                                    'href': '#',
                                    'data-toggle': 'modal',
                                    'data-target': '#modal-nuevo'
                                }).append(
                                    $('<i>').addClass('fa fa-plus')
                                ).append(' Nuevo pedido').addClass('btn btn-sm btn-success ml-2')
                            ).addClass('mb-0')
                        );
                    }
                    // agrega el pedido pendiente
                    if (result.data.pendientes.length > 0) {
                        var ul = $('<ul>');
                        ul.append(
                            $('<p>').html('Pedidos en proceso de aprobación').addClass('mt-4 mb-2 text-success')
                        )
                        for (let ipedido of result.data.pendientes) {
                            ul.append(
                                $('<a>').append(
                                    $('<p>').text(ipedido.pedido).append(
                                        $('<small>').text('Clic para ver el detalle').addClass('text-secondary ml-2 font-italic')
                                    ).addClass('my-auto mr-auto text-primary font-weight-bold')
                                ).append(
                                    $('<p>').html('Importe: <b>' + ipedido.importe.toLocaleString('en-us', {minimumFractionDigits:2,maximumFractionDigits:2}) + '</b>, del <b>' + ipedido.fecha + '</b>').addClass('my-auto text-left')
                                ).attr('href','/extranet/detalle-pedido/' + ipedido.pedido).addClass('list-group-item list-group-item-action d-flex w-100 justify-content-between')
                            );
                        }
                        ul.addClass('list-group');
                        $('#pedido').append(ul);
                    }
                    // cuenta corriente
                    let ctacte = result.data.ctacte;
                    let tbody = $('<tbody>');
                    if (ctacte.length > 0) {
                        for (let fila of ctacte) {
                            tbody.append(
                                $('<tr>').append(
                                    $('<th>').html(fila.documento).addClass('text-primary')
                                ).append(
                                    $('<td>').html(fila.moneda + ' ' + fila.deuda.toLocaleString('en-us', { minimumFractionDigits: 2, maximumFractionDigits: 2 })).addClass('text-right')
                                ).append(
                                    $('<td>').append(
                                        $('<a>').attr({
                                            'href': '#'
                                        }).append(
                                            $('<i>').addClass('fa fa-money')
                                        ).append(' Ver pagos').addClass('btn btn-sm btn-info')
                                    )
                                ).append(
                                    $('<td>').html(fila.vence)
                                ).append(
                                    $('<td>').html(fila.cpago)
                                ).append(
                                    $('<td>').html(fila.vendedor)
                                ).append(
                                    $('<td>').append(
                                        $('<a>').attr({
                                            'href': '#',
                                            'data-toggle': 'modal',
                                            'data-target': '#modal-detalle',
                                            'data-codigo': fila.documento,
                                            'data-tipo': 'F'
                                        }).append(
                                            $('<i>').addClass('fa fa-eye')
                                        ).append(' Detalle pedido').addClass('btn btn-sm btn-warning')
                                    )
                                )
                            );
                        }
                    }
                    else {
                        tbody.append(
                            $('<tr>').append(
                                $('<td>').text('No registra documentos con deuda').attr('colspan', 7)
                            )
                        );
                    }
                    $('#ctacte').append(
                        $('<table>').append(
                            $('<thead>').append(
                                $('<tr>').append(
                                    $('<th>').html('Documento')
                                ).append(
                                    $('<th>').html('Deuda')
                                ).append(
                                    $('<th>').html('Pagos')
                                ).append(
                                    $('<th>').html('Vence')
                                ).append(
                                    $('<th>').html('Cond.Pago')
                                ).append(
                                    $('<th>').html('Vendedor')
                                ).append(
                                    $('<th>').html('Detalles')
                                )
                            )
                        ).append(tbody).addClass('table table-hover table-striped')
                    );
                }
                catch (err) {
                    alert(err);
                    console.error(err);
                }
            }

            ProcesarPedido = async (event) => {
                event.preventDefault();
                /*alert('Su pedido ha sido registrado. A continuación, podrá ingresar los productos');
                location.href = '/extranet/detalle-pedido';*/
                try {
                    let result;
                    if (sesdata.tipo == 'E') {
                        result = await $.ajax({
                            url: '/extranet/pre-pedido',
                            method: 'post',
                            data: {
                                cliente: Cliente.codigo,
                                fecha: document.getElementById('np-fentrega').value
                            },
                            dataType: 'json'
                        });
                    }
                    else {
                        //
                    }
                    if (result.error) {
                        alert(result.error);
                        return;
                    }
                    alert('Se creó el pedido ' + result.pedido + '. A continuación, podrá agregar los productos.');
                    location.href = '/extranet/detalle-pedido/' + result.pedido;
                }
                catch (err) {
                    alert(err);
                }
            }

            MuestraPedidosPendientes = async _ => {
                $('#aprobacion').empty();
                // aprobacion
                try {
                    let result = await $.ajax({
                        url: '/extranet/pedidos-pendientes',
                        method: 'get',
                        // data: { empresa: sesdata.empresa },
                        data: { empresa: 11 },
                        dataType: 'json'
                    });
                    if (result.error) {
                        alert(result.error);
                        return;
                    }
                    const pedidos = result.pedidos;
                    if (pedidos.length > 0) {
                        let ul = $('<ul>').addClass('list-group');
                        for (let pedido of pedidos) {
                            ul.append(
                                $('<li>').append(
                                    $('<p>').text(pedido.pedido).addClass('my-auto mr-4 text-primary font-weight-bold')
                                ).append(
                                    $('<div>').append(
                                        $('<p>').text(pedido.nomcliente).addClass('mb-1 font-weight-bold')
                                    ).append(
                                        $('<small>').html('Fecha: <b>' + pedido.fcierre + '</b> - Importe: <b>' + pedido.importe.toLocaleString('en-us', {minimumFractionDigits:2,maximumFractionDigits:2}) + '</b>').addClass('font-italic mb-0 text-muted')
                                    ).addClass('my-auto mr-auto')
                                ).append(
                                    $('<a>').attr({
                                        'href': '/extranet/detalle-pedido/' + pedido.pedido,
                                        /*'data-toggle': 'modal',
                                        'data-target': '#modal-detalle',*/
                                        'data-tipo': 'P',
                                        'data-codigo': pedido.pedido
                                    }).text('Ver pedido').prepend(
                                        $('<i>').addClass('fa fa-eye mr-1')
                                    ).addClass('btn btn-sm btn-success my-auto')
                                ).addClass('list-group-item list-group-item-action d-flex w-100 justify-content-between')
                            );
                        }
                        $('#aprobacion').append(
                            $('<h3>').text('Pedidos pendientes de aprobación').addClass('font-weight-light mt-5')
                        ).append(
                            $('<hr>')
                        ).append(ul);
                    }
                }
                catch (err) {
                    alert(err);
                }
            }
            modalDetalleOnShow = async args => {
                let a = args.relatedTarget;
                $('#t-detalle').empty();
                if (a.dataset.tipo == 'P') {
                    $('#btn-genera').show();
                }
                else {
                    $('#btn-genera').hide();
                }
                document.getElementById('t-codigo').value = a.dataset.codigo;
                try {
                    let result = await $.ajax({
                        url: '/extranet/detalle-pedido',
                        method: 'get',
                        data: {
                            tipo: a.dataset.tipo,
                            // empresa: sesdata.empresa,
                            empresa: 11,
                            codigo: a.dataset.codigo
                        },
                        dataType: 'json'
                    });
                    if (result.error) {
                        alert(result.error);
                        $('#modal-detalle').modal('hide');
                        return;
                    }
                    const detalle = result.pedidos;
                    let moneda = '';
                    let cantidad = 0;
                    let importe = 0;
                    if (detalle.length > 0) {
                        for (let item of detalle) {
                            $('#t-detalle').append(
                                $('<tr>').append(
                                    $('<td>').text(item.codigo)
                                ).append(
                                    $('<td>').text(item.producto)
                                ).append(
                                    $('<td>').text(item.cantidad).addClass('text-right')
                                ).append(
                                    $('<td>').text(item.importe.toLocaleString('en-us',{minimumFractionDigits:2,maximumFractionDigits:2})).addClass('text-right')
                                )
                            );
                            moneda = item.moneda;
                            cantidad += item.cantidad;
                            importe += item.importe;
                        }
                        document.getElementById('t-cantidad').innerHTML = cantidad;
                        document.getElementById('t-importe').innerHTML = moneda + ' ' + importe.toLocaleString('en-us', {minimumFractionDigits:2,maximumFractionDigits:2});
                    }
                    else {
                        $('#t-detalle').append(
                            $('<tr>').append(
                                $('<td>').attr('colspan', 4).text('El pedido no tiene productos')
                            )
                        );
                    }
                }
                catch (err) {
                    console.error(err);
                }
            }
            procesarPrePedido = async e => {
                e.preventDefault();
                try {
                    let result = await $.ajax({
                        url: '/extranet/procesar-pre-pedido',
                        method: 'post',
                        data: {
                            empresa: 11,
                            prepedido: document.getElementById('t-codigo').value
                        },
                        dataType: 'json'
                    });
                    if (result.error) {
                        alert(result.error);
                        return;
                    }
                    $('#modal-detalle').modal('hide');
                    MuestraPedidosPendientes();
                    alert(result.pedido);
                }
                catch (err) {
                    console.log(err);
                }
            }

            $('#form-busca').on('submit', BuscarClientes);
            $('#modal-nuevo .modal-body .datepicker').val('');
            $('#modal-nuevo .modal-footer .btn-primary').on('click', ProcesarPedido);
            $('#modal-detalle').on('show.bs.modal', modalDetalleOnShow);
            $('#btn-genera').on('click', procesarPrePedido);
            document.getElementById('np-fentrega').value = (new Date()).toLocaleDateString('en-GB');
            document.getElementById('bs-cliente').value = '';
            $('.datepicker').datepicker({
                autoclose: true,
                format: 'dd/mm/yyyy',
                language: 'es',
                startDate: '0'
            });
            if (sesdata.admin == 'N') {
                CargarDatosCliente(sesdata.codigo);
                document.getElementById('dv-busca-cliente').remove();
            }
            else {
                if (tmpCliente != '-') CargarDatosCliente(tmpCliente);
                MuestraPedidosPendientes();
            }
        </script>
    </body>
</html>