<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Web Service Corporación Life</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="/assets/vendor/font-awesome-4.7.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="/assets/intranet/css/main.css">
        <link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />
        <style>
            body {padding-top:60px}
            .bg-purple {background-color:#7e57c2}
            .btn-xs{padding:4px 8px;font-size:12px}
            .btn-outline-secondary{padding:.25rem .75rem !important;}
            #productos{display:none}
        </style>
    </head>
    <body>
        <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-main">
            <a class="navbar-brand pb-1" href="#">
                <img src="/assets/intranet/images/clife-banner-light.svg" alt="Corporacion Life" style="height:24px;">
            </a>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="#">Ingreso manual de pedidos</a>
                    </li>
                </ul>
            </div>
            <button id="sidebar-toggler" class="navbar-toggler" type="button" aria-expanded="false">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/ws-life" role="button" aria-haspopup="true" aria-expanded="false">
                            <i class="fa fa-home mr-2"></i>Volver</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
        <!-- SEPARADOR DE BAJO PRESUPUESTO -->
        <div class="container">
            <div class="row">
                <div class="col">
                    <div class="alert alert-light shadow-sm px-4 pt-2 pb-3 mb-2">
                        <div class="row">
                            <div class="col">
                                <label for="cliente-dni" class="mb-1 text-primary font-weight-bold text-uppercase">Datos del cliente</label>
                                <div class="d-flex">
                                    <input id="cliente-dni" type="text" class="form-control form-control-sm my-auto" placeholder="DNI del cliente" style="width:144px">
                                    <a id="btn-valida-cliente" href="#" class="btn btn-success btn-xs my-auto ml-1 mr-2"><i class="fa fa-search"></i></a>
                                    <p id="datos-cliente" class="my-auto text-secondary flex-grow-1">No ha seleccionado ningún cliente</p>
                                </div>
                                <input type="hidden" id="cliente-codigo">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col">
                                <label for="cliente-dni" class="mb-1">Seleccione la dirección</label>
                                <select class="form-control form-control-sm" id="cliente-cbdireccion">
                                    <option value="-1">- Seleccione -</option>
                                </select>
                                <input type="hidden" id="cliente-direccion">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="alert alert-light shadow-sm px-4 pt-2 pb-3 mb-2">
                        <p class="text-primary font-weight-bold text-uppercase mb-2">Datos del pedido</p>
                        <div class="row mb-3">
                            <div class="col-4">
                                <label for="pedido-orderid">Order Id <i data-toggle="tooltip" data-html="true" title="<img src='/assets/ws/orderid.png' width='640px' style='display:inline-block;'>" class="fa fa-question-circle"></i></label>
                                <input type="text" class="form-control form-control-sm" id="pedido-orderid" placeholder="OrderId de VTEX">
                            </div>
                            <div class="col-5">
                                <label for="pedido-pagoid">ID pasarela <i data-toggle="tooltip" data-html="true" title="<img src='/assets/ws/pago.png' width='640px' style='display:inline-block;'>" class="fa fa-question-circle"></i></label>
                                <input type="text" class="form-control form-control-sm" id="pedido-pagoid" placeholder="ID pasarela">
                            </div>
                            <div class="col-3">
                                <label for="pedido-tid">TID pasarela</label>
                                <input type="text" class="form-control form-control-sm" id="pedido-tid" placeholder="TID pasarela">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label for="pedido-fecha">Fecha del pedido</label>
                                <input type="text" class="form-control form-control-sm" id="pedido-fecha" placeholder="dd/mm/yyyy">
                            </div>
                            <div class="col">
                                <label for="pedido-solfactura">Comprobante</label>
                                <select class="form-control form-control-sm" id="pedido-solfactura">
                                    <option value="N" selected="true">Boleta de venta</option>
                                    <option value="S">Factura</option>
                                </select>
                            </div>
                            <div class="col">
                                <label for="pedido-flete">Flete</label>
                                <input type="text" class="form-control form-control-sm" id="pedido-flete" placeholder="Costo del flete">
                            </div>
                            <div class="col">
                                <label for="pedido-tipopago">Método de pago</label>
                                <select class="form-control form-control-sm" id="pedido-tipopago">
                                    <option value="-1" selected="true" disabled="true">- Seleccione -</option>
                                    <option value="18">PagoEfectivo</option>
                                    <option value="19">PayU</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="alert alert-light shadow-sm px-4 pt-2 pb-3 mb-2">
                        <p class="text-primary font-weight-bold text-uppercase mb-2">Detalle del pedido</p>
                        <div class="d-flex mb-2">
                            <p id="detalle-datos" class="my-auto flex-grow-1">Para añadir productos, primero debe seleccionar una fecha para cargar la lista de precios</p>
                            <a href="#" class="btn btn-xs btn-info" data-toggle="modal" data-target="#modal-producto"><i class="fa fa-plus mr-1"></i>Agregar producto</a>
                        </div>
                        <div id="productos">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th colspan="2">Producto</th>
                                        <th>Cantidad</th>
                                        <th>Precio Venta</th>
                                        <th>Descuento lista</th>
                                        <th>Descuento cupón</th>
                                        <th>Subtotal</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="detalle-pedido"></tbody>
                                <tfoot>
                                    <tr>
                                        <th></th>
                                        <th>TOTAL</th>
                                        <th id="total-cantidad"></th>
                                        <th colspan="3"></th>
                                        <th id="total-importe"></th>
                                        <th></th>
                                    </tr>
                                </tfoot>
                            </table>
                            <a href="#" id="confirma-pedido" class="btn btn-sm btn-success"><i class="fa fa-floppy-o mr-2"></i>Confirmar el pedido</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <!-- modals -->
    <div id="modal-token" class="modal fade" tabindex="-1" data-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Token de Autenticación</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row mb-1">
                        <div class="col">
                            <form>
                                <div class="row">
                                    <div class="col">
                                        <label for="token" class="mb-1">Ingrese el token de validación para continuar</label>
                                        <input type="text" class="form-control form-control-sm" id="token" placeholder="Coloque aquí el token de autenticación del web service">
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-light" data-dismiss="modal">Cerrar esta ventana</button>
                    <button type="button" class="btn btn-sm btn-primary" id="confirma-token"><i class="fa fa-check mr-1"></i>Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- modal nuevo producto -->
    <div id="modal-producto" class="modal fade" tabindex="-1" data-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar producto</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="mb-2">Lista de precios: <span id="modal-producto-lista" class="text-success text-uppercase font-weight-bold"></span></p>
                    <input type="hidden" id="producto-codigo">
                    <div class="row mb-1">
                        <div class="col">
                            <div class="row mb-2">
                                <div class="col-6">
                                    <label for="producto-codbusca" class="my-auto">Codigo</label>
                                    <div class="d-flex">
                                        <input id="producto-codbusca" type="text" class="form-control form-control-sm my-auto mr-2 flex-grow-1" placeholder="Ingrese el código">
                                        <a href="#" id="btn-producto-buscar" class="btn btn-xs btn-primary"><i class="fa fa-search"></i></a>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label for="producto-producto" class="my-auto">Producto</label>
                                    <input id="producto-producto" type="text" class="form-control form-control-sm" placeholder="-" readonly>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label for="producto-cantidad" class="my-auto">Cantidad</label>
                                    <input id="producto-cantidad" type="text" class="form-control form-control-sm" placeholder="¿Cuántos?">
                                </div>
                                <div class="col">
                                    <label for="producto-punit" class="my-auto">Precio unit.</label>
                                    <input id="producto-punit" type="text" class="form-control form-control-sm" value="0.00" readonly>
                                </div>
                                <div class="col">
                                    <label for="producto-descuento" class="my-auto">Dscto. lista</label>
                                    <input id="producto-descuento" type="text" class="form-control form-control-sm" value="0" readonly>
                                </div>
                                <div class="col">
                                    <label for="producto-cupon" class="my-auto">Dscto. cupón</label>
                                    <input id="producto-cupon" type="text" class="form-control form-control-sm" value="0">
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-5">
                                    <label for="producto-subtotal" class="my-auto">Subtotal</label>
                                    <input id="producto-subtotal" type="text" class="form-control form-control-sm" value="0" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-light" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-sm btn-primary" id="confirma-producto"><i class="fa fa-check mr-1"></i>Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- modal nuevo cliente -->
    <div id="modal-cliente" class="modal fade" tabindex="-1" data-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar cliente</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row mb-1">
                        <div class="col">
                            <div class="row mb-2">
                                <div class="col">
                                    <label for="cliente-rucdni" class="my-auto">Doc. identidad</label>
                                    <input id="cliente-rucdni" type="text" class="form-control form-control-sm" placeholder="Ingrese documento de identidad">
                                </div>
                                <div class="col">
                                    <label for="cliente-tipodoc" class="my-auto">Doc. identidad</label>
                                    <select class="form-control form-control-sm" id="cliente-tipodoc">
                                        <option value="-1" selected disabled>- Seleccione -</option>
                                        <option value="1">DNI</option>
                                        <option value="6">RUC</option>
                                        <option value="4">CE</option>
                                        <option value="7">PAS</option>
                                        <option value="0">Otros</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label for="cliente-apepat" class="my-auto">Apellido paterno</label>
                                    <input id="cliente-apepat" type="text" class="form-control form-control-sm" placeholder="Ingrese apellido paterno">
                                </div>
                                <div class="col">
                                    <label for="cliente-apemat" class="my-auto">Apellido materno</label>
                                    <input id="cliente-apemat" type="text" class="form-control form-control-sm" placeholder="Ingrese apellido materno">
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label for="cliente-nombres" class="my-auto">Nombres</label>
                                    <input id="cliente-nombres" type="text" class="form-control form-control-sm" placeholder="Ingrese nombres">
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4">
                                    <label for="cliente-telefono" class="my-auto">Teléfono</label>
                                    <input id="cliente-telefono" type="text" class="form-control form-control-sm" placeholder="999999999">
                                </div>
                                <div class="col-8">
                                    <label for="cliente-email" class="my-auto">e-mail</label>
                                    <input id="cliente-email" type="text" class="form-control form-control-sm" placeholder="nombre@servidor.com">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-light" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-sm btn-primary" id="confirma-cliente"><i class="fa fa-check mr-1"></i>Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- modal token -->
    <div id="modal-token" class="modal fade" tabindex="-1" data-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Token de Autenticación</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row mb-1">
                        <div class="col">
                            <form>
                                <div class="row">
                                    <div class="col">
                                        <label for="token" class="mb-1">Ingrese el token de validación para continuar</label>
                                        <input type="text" class="form-control form-control-sm" id="token" placeholder="Coloque aquí el token de autenticación del web service">
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-light" data-dismiss="modal">Cerrar esta ventana</button>
                    <button type="button" class="btn btn-sm btn-primary" id="confirma-token"><i class="fa fa-check mr-1"></i>Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- scripts -->
    <script src="/assets/vendor/jquery/jquery-3.2.1.min.js"></script>
    <script src="/assets/bootstrap/js/popper.min.js"></script>
    <script src="/assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="/assets/vendor/tableexport/lib/js-xlsx/xlsx.core.min.js"></script>
    <script type="text/javascript" src="/assets/vendor/tableexport/lib/FileSaver/FileSaver.min.js"></script> 
    <script type="text/javascript" src="/assets/vendor/tableexport/lib/html2canvas/html2canvas.min.js"></script>
    <script type="text/javascript" src="/assets/vendor/tableexport/tableExport.js"></script>
    <script>
        let ApiToken;
        let ListaPrecios;
        let ListaProductos;

        function modalTokenOnShow() {
            document.getElementById('token').value = '';
        }
        function confirmaToken(event) {
            event.preventDefault();
            ApiToken = document.getElementById('token').value;
            $('#modal-token').modal('hide');
            $('#cliente-dni').focus();
        }
        function reiniciaFormulario() {
            document.getElementById('cliente-dni').value = '';
            $('#datos-cliente').text('No ha seleccionado ningún cliente').removeClass('text-dark').addClass('text-secondary');
            document.getElementById('cliente-codigo').value = '';
            document.getElementById('cliente-direccion').value = '';
            $('#cliente-cbdireccion').empty().append(
                $('<option>').val(-1).text('- Seleccione -').prop('selected', true).prop('disabled', true)
            );
        }
        function modalClienteOnShow() {
            $('#cliente-tipodoc option[value=1]').prop('selected',true);
            document.getElementById('cliente-rucdni').value = '';
            document.getElementById('cliente-apepat').value = '';
            document.getElementById('cliente-apemat').value = '';
            document.getElementById('cliente-nombres').value = '';
            document.getElementById('cliente-telefono').value = '';
            document.getElementById('cliente-email').value = '';
        }
        function modalProductoOnShow() {
            document.getElementById('producto-codigo').value = '';
            document.getElementById('producto-codbusca').value = '';
            document.getElementById('producto-producto').value = '';
            document.getElementById('producto-cantidad').value = '1';
            document.getElementById('producto-punit').value = '0';
            document.getElementById('producto-descuento').value = '0';
            document.getElementById('producto-cupon').value = '0';
            document.getElementById('producto-subtotal').value = '0';
        }
        function modalProductoOnShown() {
            if (!ListaPrecios) {
                $('#modal-producto').modal('hide');
                alert('Seleccione la fecha del pedido para cargar la lista de precios');
            }
        }
        function seleccionarDireccion() {
            var direccion = document.getElementById('cliente-cbdireccion').value;
            if (direccion == '0') {
                console.log('nueva direccion');
            }
            else {
                document.getElementById('cliente-direccion').value = direccion;
            }
        }
        // llamadas ajax
        function ajax_verifica_dni(event) {
            event.preventDefault();
            $.ajax({
                url: '/ws-life/datos-cliente',
                method: 'get',
                data: { cliente: document.getElementById('cliente-dni').value },
                dataType: 'json',
                headers: { authorization: ApiToken },
                success: function (response) {
                    if (response.error) {
                        if(response.error == 'Cliente no existe') {
                            document.getElementById('cliente-rucdni').value = document.getElementById('cliente-dni').value;
                            $('#modal-cliente').modal('show');
                        }
                        else {
                            alert(response.error);
                        }
                        return;
                    }
                    let result = response.result;
                    // escribe los datos del cliente
                    $('#datos-cliente').html(result.rsocial + ' - <b>Tlf.:</b> ' + result.telefono + ' - <b>e-mail:</b> ' + result.email).removeClass('text-secondary').addClass('text-dark');
                    document.getElementById('cliente-codigo').value = result.rucdni;
                    // carga las direcciones
                    ajax_direcciones_cliente();
                },
                error: function (error) {
                    alert(error);
                }
            });
        }
        function ajax_registra_cliente(event) {
            event.preventDefault();
            var data = {
                rucdni: document.getElementById('cliente-rucdni').value,
                nombre1: document.getElementById('cliente-apepat').value,
                nombre2: document.getElementById('cliente-apemat').value,
                nombre3: document.getElementById('cliente-nombres').value,
                tipodoc: document.getElementById('cliente-tipodoc').value,
                email: document.getElementById('cliente-email').value,
                telefono: document.getElementById('cliente-telefono').value
            };
            $.ajax({
                url: '/ws-life/registra-cliente',
                method: 'get',
                data: data,
                dataType: 'json',
                headers: { authorization: ApiToken },
                success: function (response) {
                    if (response.error) {
                        alert(response.error);
                        return;
                    }
                    $('#datos-cliente').html(data.nombre1 + ' ' + data.nombre2 + ' ' + data.nombre3 + ' - <b>Tlf.:</b> ' + data.telefono + ' - <b>e-mail:</b> ' + data.email).removeClass('text-secondary').addClass('text-dark');
                    document.getElementById('cliente-codigo').value = data.rucdni;
                    $('#modal-cliente').modal('hide');
                    $('#cliente-cbdireccion').empty().append(
                        $('<option>').val(-1).text('- Seleccione -').prop('selected', true).prop('disabled', true)
                    ).append(
                        $('<option>').val(0).text('NUEVA DIRECCION').addClass('text-success')
                    );
                },
                error: function (error) {
                    alert(error);
                }
            });
        }
        function ajax_direcciones_cliente() {
            var data = {
                rucdni: document.getElementById('cliente-codigo').value
            };
            $.ajax({
                url: '/ws-life/direcciones-cliente',
                method: 'get',
                data: data,
                dataType: 'json',
                headers: { authorization: ApiToken },
                success: function (response) {
                    if (response.error) {
                        alert(response.error);
                        return;
                    }
                    $('#cliente-cbdireccion').empty().append(
                        $('<option>').val(-1).text('- Seleccione -').prop('selected', true).prop('disabled', true)
                    ).append(
                        $('<option>').val(0).text('NUEVA DIRECCION').addClass('text-success')
                    );
                    for (let direccion of response.data) {
                        $('#cliente-cbdireccion').append(
                            $('<option>').val(direccion.codigo).text(direccion.direccion + ' - Ref. ' + direccion.referencias + ' [' + direccion.distrito + ']')
                        );
                    }
                },
                error: function (error) {
                    alert(error);
                }
            });
        }
        function ajax_datos_lisprecios() {
            $.ajax({
                url: '/ws-life/datos-lista-precios',
                method: 'get',
                data: { fecha: document.getElementById('pedido-fecha').value },
                dataType: 'json',
                headers: { authorization: ApiToken },
                success: function (response) {
                    if (response.error) {
                        alert(response.error);
                        return;
                    }
                    response = response.datos;
                    if (response.codigo == -1) {
                        alert(response.onombre);
                        return;
                    }
                    // detalle-datos
                    ListaPrecios = response;
                    document.getElementById('detalle-datos').innerHTML = 'Lista de precios: <span class="text-success font-weight-bold">' + ListaPrecios.onombre + '</span> - Vigencia del <span class="text-success">' + ListaPrecios.oinicio + '</span> al <span class="text-success">' + ListaPrecios.ofin + '</span>';
                    document.getElementById('modal-producto-lista').innerHTML = ListaPrecios.onombre;
                },
                error: function (error) {
                    alert(error);
                }
            });
        }
        function calculaSubtotalProducto() {
            var cantidad = parseInt(document.getElementById('producto-cantidad').value);
            var pventa = parseFloat(document.getElementById('producto-punit').value);
            var dscto1 = parseFloat(document.getElementById('producto-descuento').value);
            var dscto2 = parseFloat(document.getElementById('producto-cupon').value);
            var subtotal = cantidad * pventa * (100 - dscto1 - dscto2) / 100;
            document.getElementById('producto-subtotal').value = subtotal.toLocaleString('en-us', {minimumFractionDigits:2,maximumFractionDigits:2});
        }
        function eliminaProducto(event) {
            event.preventDefault();
            var pos = $(this).data('pos');
            ListaProductos.splice(pos,1);
            muestraListaProductos();
        }
        function muestraListaProductos() {
            $('#detalle-pedido').empty();
            let tcantidad = 0;
            let timporte = 0;
            let i = 0;
            if (ListaProductos.length > 0) {
                $('#productos').fadeIn(250);
                for (let producto of ListaProductos) {
                    let icantidad = producto.cantidad;
                    let isubtotal = producto.subtotal;
                    $('#detalle-pedido').append(
                        $('<tr>').append(
                            $('<td>').text(producto.codigo).addClass('text-right')
                        ).append(
                            $('<td>').text(producto.descripcion)
                        ).append(
                            $('<td>').text(icantidad).addClass('text-right')
                        ).append(
                            $('<td>').text(producto.punit).addClass('text-right')
                        ).append(
                            $('<td>').text(producto.descuento).addClass('text-right')
                        ).append(
                            $('<td>').text(producto.cupon).addClass('text-right')
                        ).append(
                            $('<td>').text(isubtotal).addClass('text-right')
                        ).append(
                            $('<td>').append(
                                $('<a>').append(
                                    $('<i>').addClass('fa fa-remove')
                                ).attr({
                                    href: '#',
                                    'data-pos': i
                                }).addClass('btn btn-xs btn-danger').on('click', eliminaProducto)
                            )
                        )
                    );
                    tcantidad += icantidad;
                    timporte += isubtotal;
                    i++;
                }
                document.getElementById('total-cantidad').innerHTML = tcantidad.toLocaleString('en-us',{minimumFractionDigits:0,maximumFractionDigits:0});
                document.getElementById('total-importe').innerHTML = timporte.toLocaleString('en-us',{minimumFractionDigits:2,maximumFractionDigits:2});
            }
            else {
                $('#productos').hide();
            }
        }
        function agregaProducto(event) {
            event.preventDefault();
            ListaProductos.push({
                codigo: document.getElementById('producto-codigo').value,
                descripcion: document.getElementById('producto-producto').value,
                cantidad: parseInt(document.getElementById('producto-cantidad').value),
                punit: document.getElementById('producto-punit').value,
                descuento: document.getElementById('producto-descuento').value,
                cupon: document.getElementById('producto-cupon').value,
                subtotal: parseFloat(document.getElementById('producto-subtotal').value)
            });
            muestraListaProductos();
            $('#modal-producto').modal('hide');
        }
        function cargaDatosProducto(event) {
            event.preventDefault();
            $.ajax({
                url: '/ws-life/carga-datos-producto',
                method: 'get',
                data: {
                    producto: document.getElementById('producto-codbusca').value,
                    colista: ListaPrecios.olista,
                    serielista: ListaPrecios.oserie
                },
                dataType: 'json',
                headers: { authorization: ApiToken },
                success: function (response) {
                    if (response.error) {
                        alert(response.error);
                        return;
                    }
                    if (response.codigo == -1) {
                        alert(response.onombre);
                        return;
                    }
                    document.getElementById('producto-codigo').value = response.codigo;
                    document.getElementById('producto-producto').value = response.descripcion;
                    document.getElementById('producto-punit').value = response.pventa.toLocaleString('en-us',{minimumFractionDigits:2,maximumFractionDigits:2});
                    document.getElementById('producto-descuento').value = response.descuento.toLocaleString('en-us',{minimumFractionDigits:0,maximumFractionDigits:0});
                    calculaSubtotalProducto();
                },
                error: function (error) {
                    alert(error);
                }
            });
        }
        function generaDetallePedido() {
            let arr_detalle = [];
            for (let producto of ListaProductos) {
                let arr_producto = [
                    producto.codigo,
                    producto.cantidad,
                    producto.punit,
                    producto.subtotal,
                    producto.descuento,
                    producto.cupon
                ];
                arr_detalle.push(arr_producto.join('|'));
            }
            return arr_detalle.join('@');
        }
        function confirmaPedido(event) {
            event.preventDefault();
            if (window.confirm('El pedido será ingresado al sistema. ¿Confirma esta acción?')) {
                $('#confirma-pedido').hide();
                var data = {
                    cliente: document.getElementById('cliente-codigo').value,
                    direccion: document.getElementById('cliente-direccion').value,
                    fecha: document.getElementById('pedido-fecha').value,
                    factura: document.getElementById('pedido-solfactura').value,
                    flete: document.getElementById('pedido-flete').value,
                    orderid: document.getElementById('pedido-orderid').value,
                    sispago: document.getElementById('pedido-tipopago').value,
                    observaciones: 'WebServiceCorporacionLife',
                    detalle: generaDetallePedido(),
                    pagoid: document.getElementById('pedido-tid').value + '-' + document.getElementById('pedido-pagoid').value,
                    fepago: document.getElementById('pedido-fecha').value,
                    deposito: 0,
                    comision: 0,
                    igv: 0,
                    pventa: 0
                };
                // valida y despues probar
                if (data.cliente == '') {
                    alert('Seleccione el cliente');
                    return;
                }
                if (data.direccion == '' || data.direccion == '-1' || data.direccion == '0') {
                    alert('Seleccione la dirección del cliente');
                    return;
                }
                if (data.fecha == '') {
                    alert('Ingrese la fecha del pedido');
                    return;
                }
                if (data.sispago == '-1') {
                    alert('Especifique la forma de pago');
                    return;
                }
                if (data.fecha == '') {
                    alert('Ingrese la fecha del pedido');
                    return;
                }
                if (data.orderid == '') {
                    alert('Especifique el Order ID de VTEX');
                    return;
                }
                if (document.getElementById('pedido-tid').value == '' || document.getElementById('pedido-pagoid').value == '') {
                    alert('Ingrese correctamente la información de pago (ID y TID pasarela)');
                    return;
                }
                if (data.detalle == '') {
                    alert('Debe añadir al menos un producto');
                    return;
                }
                // grabar alv
                $.ajax({
                    url: '/ws-life/registra-pedido',
                    headers: { authorization: ApiToken },
                    method: 'post',
                    data: data,
                    dataType: 'json',
                    success: function(response) {
                        $('#confirma-pedido').show();
                        if (response.error) {
                            alert(response.error);
                            return;
                        }
                        alert('Pedido registrado con código ' + response.pedido);
                        location.href = '/ws-life/pedidos-realizados';
                    },
                    error: function(error) {
                        alert(error);
                    }
                });
            }
        }
function go() {
    setTimeout(function() {
        document.getElementById('token').value = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MywiZW1wcmVzYSI6IjExIiwiYWxpYXMiOiJjbGlmZSIsImlhdCI6MTYxMjU3MjkwNiwiZXhwIjoxNjEyODMyMTA2fQ.OQdgPElg9cBvLSyZ9xv1lP1_jaFTIUtvALxWalt6BNU';
        $('#confirma-token').trigger('click');
    }, 500);
}
        function init() {
            ListaProductos = new Array();
            $('[data-toggle="tooltip"]').tooltip();
            $('#pedido-fecha').datepicker({
                // locale: 'es-es',
                format: 'dd/mm/yyyy',
                datepicker: { weekStartDay: 1 },
                uiLibrary: 'bootstrap4',
                iconsLibrary: 'fontawesome',
                change: ajax_datos_lisprecios
            });
            reiniciaFormulario();
            $('#modal-token').on('show.bs.modal', modalTokenOnShow);
            $('#modal-token').modal('show');
            $('#confirma-token').on('click', confirmaToken);
            $('#confirma-cliente').on('click', ajax_registra_cliente);
            $('#btn-valida-cliente').on('click', ajax_verifica_dni);
            $('#modal-cliente').on('show.bs.modal', modalClienteOnShow);
            $('#modal-producto').on('show.bs.modal', modalProductoOnShow);
            $('#modal-producto').on('shown.bs.modal', modalProductoOnShown);
            $('#cliente-cbdireccion').on('change', seleccionarDireccion);
            $('#btn-producto-buscar').on('click', cargaDatosProducto);
            $('#producto-cantidad').on('keyup', calculaSubtotalProducto);
            $('#producto-cupon').on('keyup', calculaSubtotalProducto);
            $('#confirma-producto').on('click', agregaProducto);
            $('#confirma-pedido').on('click', confirmaPedido);
go();
        }
        // go
        $(init);
    </script>
</html>